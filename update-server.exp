#!/usr/bin/expect -f

set timeout 60
set server "root@45.95.234.173"
set password "o-4zWa6SFWUGo,"

spawn ssh $server

expect {
    "password:" {
        send "$password\r"
    }
    "(yes/no)?" {
        send "yes\r"
        expect "password:"
        send "$password\r"
    }
}

expect "# "

send "cd /root/TrustStore\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å git
send "echo 'üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è...'\r"
expect "# "

send "git status\r"
expect "# "

# –î–µ–ª–∞–µ–º backup —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–¥–∞
send "echo 'üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...'\r"
expect "# "

send "cp server.js server.js.backup.\$(date +%Y%m%d_%H%M%S) 2>/dev/null || echo 'Backup —Å–æ–∑–¥–∞–Ω'\r"
expect "# "

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä
send "echo 'üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...'\r"
expect "# "

send "pm2 stop trust-store || echo '–°–µ—Ä–≤–µ—Ä —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'\r"
expect "# "

# –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ —Å GitHub
send "echo 'üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ —Å GitHub...'\r"
expect "# "

send "git fetch origin\r"
expect "# "

send "git pull origin main\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
send "echo '‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω'\r"
expect "# "

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
send "echo 'üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...'\r"
expect "# "

send "npm install --production 2>&1 | tail -5 || echo '–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –ø–æ—Ä—è–¥–∫–µ'\r"
expect "# "

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
send "echo 'üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞...'\r"
expect "# "

send "pm2 restart trust-store || pm2 start server.js --name trust-store\r"
expect "# "

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
send "sleep 3\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
send "echo 'üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞:'\r"
expect "# "

send "pm2 status\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏
send "echo 'üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:'\r"
expect "# "

send "pm2 logs trust-store --lines 10 --nostream | tail -10\r"
expect "# "

send "echo ''\r"
expect "# "

send "echo '‚úÖ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!'\r"
expect "# "

send "exit\r"
expect eof

