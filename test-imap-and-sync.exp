#!/usr/bin/expect -f

set timeout 20
set server "root@45.95.234.173"
set password "o-4zWa6SFWUGo,"

spawn ssh $server

expect {
    "password:" {
        send "$password\r"
    }
}

expect "# "

send "cd /root/TrustStore\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ curl API —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–Ω—É–∂–µ–Ω —Ç–æ–∫–µ–Ω, –Ω–æ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º –ª–æ–≥–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞)
send "sleep 12 && pm2 logs trust-store --lines 50 --nostream | grep -E 'IMAP|üìß|üì¨|—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è|–ø–æ–¥–∫–ª—é—á–µ–Ω|‚úÖ|‚ùå' | tail -20\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø–∏—Å—å–º–∞ –≤ –ë–î
send "sqlite3 database.db \"SELECT COUNT(*) FROM email_messages;\" 2>/dev/null || echo '–ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'\r"
expect "# "

# –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∏—Å—å–º–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ
send "sqlite3 database.db \"SELECT from_email, subject, created_at FROM email_messages ORDER BY created_at DESC LIMIT 5;\" 2>/dev/null || echo '–ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'\r"
expect "# "

send "exit\r"
expect eof


