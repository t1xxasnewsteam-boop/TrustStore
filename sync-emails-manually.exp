#!/usr/bin/expect -f

set timeout 15
set server "root@45.95.234.173"
set password "o-4zWa6SFWUGo,"

spawn ssh $server

expect {
    "password:" {
        send "$password\r"
    }
}

expect "# "

send "cd /root/TrustStore\r"
expect "# "

# Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð¼Ð¾Ð¶ÐµÑ‚ Ð»Ð¸ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ñ‡ÐµÑ€ÐµÐ· Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚
send "cat > /tmp/test-imap.js << 'EOF'
const Imap = require('imap');
const imap = new Imap({
    user: 'orders@truststore.ru',
    password: 'Gaga007231',
    host: 'imap.yandex.ru',
    port: 993,
    tls: true,
    tlsOptions: { rejectUnauthorized: false },
    connTimeout: 10000
});

imap.once('ready', () => {
    console.log('âœ… IMAP Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!');
    imap.openBox('INBOX', false, (err, box) => {
        if (err) {
            console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ INBOX:', err.message);
            imap.end();
            return;
        }
        console.log('ðŸ“¬ Ð’ÑÐµÐ³Ð¾ Ð¿Ð¸ÑÐµÐ¼:', box.messages.total);
        imap.end();
    });
});

imap.once('error', (err) => {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ°:', err.message);
});

imap.connect();
setTimeout(() => {
    if (imap.state !== 'closed') {
        imap.end();
    }
    process.exit(0);
}, 10000);
EOF
node /tmp/test-imap.js\r"
expect "# "

send "exit\r"
expect eof


