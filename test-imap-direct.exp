#!/usr/bin/expect -f

set timeout 20
set server "root@45.95.234.173"
set password "o-4zWa6SFWUGo,"

spawn ssh $server

expect {
    "password:" {
        send "$password\r"
    }
}

expect "# "

send "cd /root/TrustStore\r"
expect "# "

# –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ IMAP —Å —Ä–∞–∑–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
send "cat > /tmp/test-imap-full.js << 'EOFSCRIPT'
const Imap = require('imap');
const { simpleParser } = require('mailparser');

const config = {
    user: 'orders@truststore.ru',
    password: 'Gaga007231',
    host: 'imap.yandex.ru',
    port: 993,
    tls: true,
    tlsOptions: { rejectUnauthorized: false },
    connTimeout: 15000
};

console.log('üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ IMAP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
console.log('üìß Email:', config.user);
console.log('üåê Host:', config.host);

const imap = new Imap(config);

imap.once('ready', () => {
    console.log('‚úÖ IMAP –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
    
    // –ü—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å —Ä–∞–∑–Ω—ã–µ –ø–∞–ø–∫–∏
    const folders = ['INBOX', 'Spam', '–°–ø–∞–º'];
    let opened = 0;
    
    folders.forEach((folder, index) => {
        imap.openBox(folder, false, (err, box) => {
            opened++;
            if (err) {
                console.log(\`‚ö†Ô∏è –ü–∞–ø–∫–∞ \${folder} –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞: \${err.message}\`);
            } else {
                console.log(\`‚úÖ –ü–∞–ø–∫–∞ \${folder}: \${box.messages.total} –ø–∏—Å–µ–º\`);
            }
            
            if (opened === folders.length) {
                imap.end();
                process.exit(0);
            }
        });
    });
});

imap.once('error', (err) => {
    console.error('‚ùå –û—à–∏–±–∫–∞:', err.message);
    console.error('üìã –î–µ—Ç–∞–ª–∏:', JSON.stringify(err, null, 2));
    
    if (err.message && err.message.includes('Invalid login')) {
        console.log('\\nüí° –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:');
        console.log('1. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –ø–∞—Ä–æ–ª—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π');
        console.log('2. –î–ª—è Yandex 360 –º–æ–∂–µ—Ç –Ω—É–∂–µ–Ω –ø–∞—Ä–æ–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: https://id.yandex.ru/security/app-passwords');
        console.log('3. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ IMAP –≤–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö: https://360.yandex.ru/');
    }
    
    process.exit(1);
});

imap.connect();

setTimeout(() => {
    if (imap.state !== 'closed') {
        console.log('‚è±Ô∏è –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        imap.end();
    }
    process.exit(0);
}, 20000);
EOFSCRIPT
node /tmp/test-imap-full.js\r"
expect "# "

send "exit\r"
expect eof


