#!/usr/bin/expect -f

set timeout 30
set server "root@45.95.234.173"
set password "o-4zWa6SFWUGo,"

spawn ssh $server

expect {
    "password:" {
        send "$password\r"
    }
    "(yes/no)?" {
        send "yes\r"
        expect "password:"
        send "$password\r"
    }
}

expect "# "

send "cd /root/TrustStore\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
send "echo 'üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ ORD-1762026621082:'\r"
expect "# "

send "node -e \"const Database = require('better-sqlite3'); const db = new Database('analytics.db'); const order = db.prepare('SELECT * FROM orders WHERE order_id = ?').get('ORD-1762026621082'); console.log(JSON.stringify(order, null, 2)); db.close();\" 2>/dev/null\r"
expect "# "

send "echo ''\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ webhook
send "echo 'üîç –ü–æ–∏—Å–∫ webhook –≤ –ª–æ–≥–∞—Ö...'\r"
expect "# "

send "pm2 logs trust-store --lines 200 --nostream | grep -E 'ORD-1762026621082|1762026621082|webhook|payment|YooMoney|Heleket' | tail -20\r"
expect "# "

send "echo ''\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏
send "echo '‚ùå –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏:'\r"
expect "# "

send "pm2 logs trust-store --err --lines 50 --nostream | grep -E 'ORD-1762026621082|1762026621082|—Å—É–º–º–∞|amount|Wrong' | tail -15\r"
expect "# "

send "echo ''\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—ã–ª –ª–∏ –≤–æ–æ–±—â–µ webhook
send "echo 'üì• –í—Å–µ webhook –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å:'\r"
expect "# "

send "pm2 logs trust-store --lines 500 --nostream | grep -E 'WEBHOOK –ü–û–õ–£–ß–ï–ù|webhook|payment' | tail -10\r"
expect "# "

send "exit\r"
expect eof

