#!/usr/bin/expect -f
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞

set timeout 30
set server "root@45.95.234.173"
set password "o-4zWa6SFWUGo,"

spawn ssh $server

expect {
    "password:" {
        send "$password\r"
    }
    "(yes/no)?" {
        send "yes\r"
        expect "password:"
        send "$password\r"
    }
}

expect "# "

send "cd /root/TrustStore\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑
send "echo 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞...'\r"
expect "# "

send "sqlite3 analytics.db \"SELECT order_id, customer_email, status, payment_method, total_amount, created_at FROM orders ORDER BY created_at DESC LIMIT 1;\" 2>/dev/null\r"
expect "# "

# –ù–∞—Ö–æ–¥–∏–º order_id –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
send "ORDER_ID=$(sqlite3 analytics.db \"SELECT order_id FROM orders WHERE status='paid' ORDER BY created_at DESC LIMIT 1;\" 2>/dev/null)\r"
expect "# "

send "echo Checking order...\r"
expect "# "

send "if [ ! -z \"$ORDER_ID\" ]; then echo \"Found order: $ORDER_ID\"; curl -X POST http://localhost:3000/api/manual-send-last-order -H 'Content-Type: application/json' -d \"{\\\"orderId\\\": \\\"$ORDER_ID\\\"}\" 2>/dev/null; else echo 'No paid order found'; fi\r"
expect "# "

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
send "echo ''\r"
expect "# "

send "echo 'üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –æ—Ç–ø—Ä–∞–≤–∫–∏...'\r"
expect "# "

send "pm2 logs trust-store --lines 20 --nostream | grep -E 'üìß|email|‚úÖ|‚ùå|–û—Ç–ø—Ä–∞–≤–∫–∞|–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω' | tail -10\r"
expect "# "

send "echo ''\r"
expect "# "

send "echo '‚úÖ –ì–æ—Ç–æ–≤–æ! –ó–∞–∫–∞–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.'\r"
expect "# "

send "exit\r"
expect eof

