#!/usr/bin/expect -f

set timeout 30
set server "root@45.95.234.173"
set password "o-4zWa6SFWUGo,"

spawn ssh $server

expect {
    "password:" {
        send "$password\r"
    }
}

expect "# "

send "cd /root/TrustStore\r"
expect "# "

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ€ÑƒÑ‡Ð½ÑƒÑŽ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ñ‡ÐµÑ€ÐµÐ· API
send "curl -X POST http://localhost:3000/api/admin/emails/sync -H 'Cookie: token=test' 2>&1 | head -20\r"
expect "# "

# Ð–Ð´ÐµÐ¼ Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸
send "sleep 10 && pm2 logs trust-store --lines 50 --nostream | grep -E 'Ð¡ÐŸÐÐœ|Spam|Ð¡Ð¿Ð°Ð¼|ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ|Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾|ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾|ðŸ“§|ðŸ“¬|ðŸš¨|âœ…|INBOX' | tail -30\r"
expect "# "

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¸ÑÑŒÐ¼Ð° Ð² Ð‘Ð”
send "node -e \"const db=require('better-sqlite3')('analytics.db');const spam=db.prepare('SELECT COUNT(*) as c FROM email_messages WHERE subject LIKE \\\"%[Ð¡ÐŸÐÐœ]%\\\"').get();console.log('ÐŸÐ¸ÑÐµÐ¼ Ñ [Ð¡ÐŸÐÐœ]:', spam.c);const last=db.prepare('SELECT from_email,subject,created_at FROM email_messages WHERE subject LIKE \\\"%[Ð¡ÐŸÐÐœ]%\\\" ORDER BY created_at DESC LIMIT 5').all();last.forEach(e=>console.log(e.from_email+' - '+e.subject));\"\r"
expect "# "

send "exit\r"
expect eof


