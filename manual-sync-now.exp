#!/usr/bin/expect -f

set timeout 30
set server "root@45.95.234.173"
set password "o-4zWa6SFWUGo,"

spawn ssh $server

expect {
    "password:" {
        send "$password\r"
    }
}

expect "# "

send "cd /root/TrustStore\r"
expect "# "

# Запускаем ручную синхронизацию через API
send "curl -X POST http://localhost:3000/api/admin/emails/sync -H 'Cookie: token=test' 2>&1 | head -20\r"
expect "# "

# Ждем и проверяем логи
send "sleep 10 && pm2 logs trust-store --lines 50 --nostream | grep -E 'СПАМ|Spam|Спам|синхронизация|обработано|сохранено|📧|📬|🚨|✅|INBOX' | tail -30\r"
expect "# "

# Проверяем письма в БД
send "node -e \"const db=require('better-sqlite3')('analytics.db');const spam=db.prepare('SELECT COUNT(*) as c FROM email_messages WHERE subject LIKE \\\"%[СПАМ]%\\\"').get();console.log('Писем с [СПАМ]:', spam.c);const last=db.prepare('SELECT from_email,subject,created_at FROM email_messages WHERE subject LIKE \\\"%[СПАМ]%\\\" ORDER BY created_at DESC LIMIT 5').all();last.forEach(e=>console.log(e.from_email+' - '+e.subject));\"\r"
expect "# "

send "exit\r"
expect eof


